
<!DOCTYPE html>
<html>
  <head>
     <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
     <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
     <link href='iframe_style.css' rel='stylesheet' type='text/css'>
     <script type="text/javascript" src="jquery.js"></script>
     <script type="text/javascript" src="slide.js"></script>
  </head>

  <body>
    
    <div id="map"></div>
    <div id="preferences">
    </div>
    
  </body>

   <script type="cartocss/html" id="coloring">
    #coloring{
      polygon-fill: #FFFFB2;
      polygon-opacity: 1;
    }

    #coloring [ {0} <= 10] {
       polygon-fill: #02820B;
    }
    #coloring [ {0} <= 9] {
       polygon-fill: #158202;
    }
    #coloring [ {0} <= 8] {
       polygon-fill: #328102;
    }
    #coloring [ {0} <= 7] {
       polygon-fill: #4E8102;
    }
    #coloring [ {0} <= 6] {
       polygon-fill: #6A8002;
    }
    #coloring [ {0} <= 5] {
       polygon-fill: #7F7802;
    }
    #coloring [ {0} <= 4] {
       polygon-fill: #7E5C02;
    }
    #coloring [ {0} <= 3] {
       polygon-fill: #7E3F02;
    }
    #coloring [ {0} <= 2] {
       polygon-fill: #7D2302;
    }
    #coloring [ {0} <= 1] {
       polygon-fill: #7C0703;
    }
    </script>

    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script> 
     
     <script>
          //Formats the columns for us into css
          String.prototype.format = (function (i, safe, arg) {
            function format() {
                var str = this,
                    len = arguments.length + 1;

                for (i = 0; i < len; arg = arguments[i++]) {
                    safe = typeof arg === 'object' ? JSON.stringify(arg) : arg;
                    str = str.replace(RegExp('\\{' + (i - 1) + '\\}', 'g'), safe);
                }
                return str;
            }
            return format;
            
        })();


    function main() {
      var loader = new cdb.geo.ui.TilesLoader({ template: function(){ return '<div class="loader"></div>' } });

        var map = new L.Map('map', { 
          zoomControl: true,
          legend:true,
          center: [40, -98],
          zoom: 3.8,
          scrollWheelZoom: true,
          searchControl: true
        });

        // create our layers
        cartodb.createLayer(map, {
          user_name: 'briannaloo',
          type: 'cartodb',
          sublayers: [{
            sql: "SELECT county_shapes.cartodb_id, county_shapes.the_geom_webmercator, county_shapes.name, cnty_fips, state_name, State, County, state_fips, population2014, glyphosate.county_fips_code, glyphosate.state_fips_code, kg, rent.median_cash_rent, rent.state, rent.area_name FROM county_shapes, county_size, glyphosate, rent",
            cartocss: $('#coloring').html().format('total_score'),
            interactivity: "cartodb_id, the_geom_webmercator, name, state_name, population2014, kg, median_cash_rent"
            }]

        }).done(function(layer) {
          function addLoader(layer) {
            layer.bind('loading', function() { loader.show() });
            layer.bind('load',  function() { loader.hide(); });
          }
          console.log("loaded data")
          // add the layers to our map 
          map.addLayer(layer);
          sublayer_county = layer.getSubLayer(0);
          sublayer_county.setInteraction(true);
          sublayer_county.setSQL(
            "SELECT cartodb_id, the_geom_webmercator, name, state_name, population2014, kg, median_cash_rent, pesticide_score, population_score, rent_score \
              (pesticide_score + population_score + rent_score)/3 as total_score \
              FROM \
            (SELECT county_shapes.cartodb_id, county_shapes.the_geom_webmercator, name, state_name, population2014, kg, median_cash_rent \
            CASE \
              WHEN kg <= 10 THEN 10 \
              WHEN kg <= 50 and kg > 10 THEN 9 \
              WHEN kg <= 100 and kg > 50 THEN 8 \
              WHEN kg <= 1000 and kg > 100 THEN 7 \
              WHEN kg <= 5000 and kg > 1000 THEN 6 \
              WHEN kg <= 10000 and kg > 5000 THEN 5 \
              WHEN kg <= 50000 and kg > 10000 THEN 4 \
              WHEN kg <= 100000 and kg > 50000 THEN 3 \
              WHEN kg <= 350000 and kg > 100000 THEN 2 \
              WHEN kg <= 700000 and kg > 350000 THEN 1 \
            END as pesticide_score, \
            CASE \
              WHEN population2014 >= 2000000 THEN 10 \
              WHEN population2014 >= 900000 and population2014 < 2000000 THEN 9 \
              WHEN population2014 >= 600000 and population2014 < 900000 THEN 8 \
              WHEN population2014 >= 400000 and population2014 < 600000 THEN 7 \
              WHEN population2014 >= 200000 and population2014 < 400000 THEN 6 \
              WHEN population2014 >= 100000 and population2014 < 200000 THEN 5 \
              WHEN population2014 >= 50000 and population2014 < 100000 THEN 4 \
              WHEN population2014 >= 15000 and population2014 < 50000 THEN 3 \
              WHEN population2014 >= 5000 and population2014 < 15000 THEN 2 \
              WHEN population2014 >= 0 and population2014 < 5000 THEN 1 \
            END as population_score \
            CASE \
              WHEN median_cash_rent <= 200 THEN 10 \
              WHEN median_cash_rent <= 400 and median_cash_rent > 200 THEN 9 \
              WHEN median_cash_rent <= 600 and median_cash_rent > 400 THEN 8 \
              WHEN median_cash_rent <= 800 and median_cash_rent > 600 THEN 7 \
              WHEN median_cash_rent <= 1000 and median_cash_rent > 800 THEN 6 \
              WHEN median_cash_rent <= 1200 and median_cash_rent > 1000 THEN 5 \
              WHEN median_cash_rent <= 1400 and median_cash_rent > 1200 THEN 4 \
              WHEN median_cash_rent <= 1600 and median_cash_rent > 1400 THEN 3 \
              WHEN median_cash_rent <= 1800 and median_cash_rent > 1600 THEN 2 \
              WHEN median_cash_rent <= 2001 and median_cash_rent > 1800 THEN 1 \
            END as rent_score \
            FROM county_shapes, county_size, glyphosate, rent \
            WHERE county_shapes.state_name=county_size.State \
            AND CONCAT(county_shapes.name,' County')=county_size.County \
            AND glyphosate.state_fips_code=county_shapes.state_fips \
            AND glyphosate.county_fips_code=county_shapes.cnty_fips ) as r \
            AND rent.state=county_shapes.state_name \
            AND rent.area_name=county_shapes.name \
            ");
          

    });
  }

      window.onload = main;


  
    </script>

</script>
</html>